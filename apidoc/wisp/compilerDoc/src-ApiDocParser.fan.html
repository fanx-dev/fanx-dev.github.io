<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns='http://www.w3.org/1999/xhtml'>
<head>
<title>ApiDocParser.fan</title>
<meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
<link rel='stylesheet' type='text/css' href='../style.css' />
</head>
<body>
<div class='breadcrumb'>
<ul>
<li><a href='../index.html'>Doc Index</a></li><li><a href='index.html'>compilerDoc</a></li><li><a href='src-ApiDocParser.fan.html'>ApiDocParser.fan</a></li></ul>
</div>
<div class='src'>
<pre>
<span id='line1'>//</span>
<span id='line2'>// Copyright <b>(</b>c<b>)</b> 2011, Brian Frank and Andy Frank</span>
<span id='line3'>// Licensed under the Academic Free License version 3.0</span>
<span id='line4'>//</span>
<span id='line5'>// History:</span>
<span id='line6'>//   11 Aug 11  Brian Frank  Creation</span>
<span id='line7'>//</span>
<span id='line8'></span>
<span id='line9'>**</span>
<span id='line10'>** ApiDocParser is used to parse the text file syntax of the</span>
<span id='line11'>** apidoc file generated by the compiler.  These files are</span>
<span id='line12'>** designed to give us full access everything we need to build</span>
<span id='line13'>** a documentation model of pods, types, and slots using a</span>
<span id='line14'>** simple human readable format.</span>
<span id='line15'>**</span>
<span id='line16'>** The syntax is defined as:</span>
<span id='line17'>**   &lt;file>      :=  &lt;class> &lt;slot>*</span>
<span id='line18'>**   &lt;class>     :=  "== " &lt;name> &lt;nl> &lt;attrs></span>
<span id='line19'>**   &lt;slot>      :=  <b>(</b>&lt;fieldSig> | &lt;methodSig><b>)</b> &lt;attrs></span>
<span id='line20'>**   &lt;fieldSig>  :=  "-- " &lt;name> &lt;sp> &lt;type> <b>[</b>":=" &lt;expr><b>]</b> &lt;nl></span>
<span id='line21'>**   &lt;methodSig> :=  "-- " &lt;name> "<b>(</b>" &lt;nl> <b>[</b>&lt;param> &lt;nl><b>]</b>* "<b>)</b>" &lt;sp> &lt;return> &lt;nl></span>
<span id='line22'>**   &lt;param>     :=  &lt;name> &lt;type> <b>[</b>":=" &lt;expr><b>]</b></span>
<span id='line23'>**   &lt;return>    :=  &lt;type></span>
<span id='line24'>**</span>
<span id='line25'>**   &lt;attrs>     :=  &lt;meta>* &lt;facet>* &lt;nl> &lt;doc>.</span>
<span id='line26'>**   &lt;meta>      :=  &lt;name> "=" &lt;expr> &lt;nl></span>
<span id='line27'>**   &lt;facet>     :=  "@" &lt;type> <b>[</b>"<b>{</b>" &lt;nl> <b>[</b>&lt;name> "=" &lt;expr> &lt;nl><b>]</b>* "<b>}</b>"<b>]</b> &lt;nl></span>
<span id='line28'>**   &lt;doc>       :=  lines of text until "-- "</span>
<span id='line29'>**</span>
<span id='line30'>**   &lt;name>      :=  Fantom identifier</span>
<span id='line31'>**   &lt;type>      :=  Fantom type signature <b>(</b>no spaces allowed<b>)</b></span>
<span id='line32'>**   &lt;expr>      :=  text until end of line</span>
<span id='line33'>**   &lt;nl>        :=  "\n"</span>
<span id='line34'>**   &lt;sp>        :=  " "</span>
<span id='line35'>**</span>
<span id='line36'>** Standard attributes:</span>
<span id='line37'>**   - base: list of space separated base class type signatures</span>
<span id='line38'>**   - mixins: list of space separated mixin type signatures</span>
<span id='line39'>**   - loc: &lt;file> ":" &lt;line> "/" &lt;docLine></span>
<span id='line40'>**   - flags: type or slot space separated flag keywords</span>
<span id='line41'>**   - set: field setter flags</span>
<span id='line42'>**</span>
<span id='line43'>** Note that the grammar is defined such that expr to display</span>
<span id='line44'>** in docs for field and parameter defaults is always positioned at</span>
<span id='line45'>** the end of the line <b>(</b>avoiding nasty escaping problems<b>)</b>.</span>
<span id='line46'>**</span>
<span id='line47'>internal class ApiDocParser</span>
<span id='line48'><b>{</b></span>
<span id='line49'>  new make<b>(</b>DocPod pod, InStream in<b>)</b></span>
<span id='line50'>  <b>{</b></span>
<span id='line51'>    this.pod = pod</span>
<span id='line52'>    this.in = in</span>
<span id='line53'>    consumeLine</span>
<span id='line54'>  <b>}</b></span>
<span id='line55'></span>
<span id='line56'>  DocType parseType<b>(</b>Bool close := true<b>)</b></span>
<span id='line57'>  <b>{</b></span>
<span id='line58'>    try</span>
<span id='line59'>    <b>{</b></span>
<span id='line60'>      // == &lt;name></span>
<span id='line61'>      if <b>(</b>!cur.startsWith<b>(</b>"== "<b>)</b><b>)</b> throw Err<b>(</b>"Expected == &lt;name>"<b>)</b></span>
<span id='line62'>      name := cur<b>[</b>3..-1<b>]</b></span>
<span id='line63'>      consumeLine</span>
<span id='line64'></span>
<span id='line65'>      // parse attrs</span>
<span id='line66'>      attrs  := parseAttrs</span>
<span id='line67'>      this.typeRef = DocTypeRef<b>(</b>"$<b>{</b>pod.name<b>}</b>::$<b>{</b>name<b>}</b>"<b>)</b></span>
<span id='line68'>      this.typeLoc = attrs.loc</span>
<span id='line69'></span>
<span id='line70'>      // zero or more slots</span>
<span id='line71'>      list := DocSlot<b>[</b>,<b>]</b></span>
<span id='line72'>      map  := Str:DocSlot<b>[</b>:<b>]</b></span>
<span id='line73'>      while <b>(</b>true<b>)</b></span>
<span id='line74'>      <b>{</b></span>
<span id='line75'>        slot := parseSlot</span>
<span id='line76'>        if <b>(</b>slot == null<b>)</b> break</span>
<span id='line77'>        list.add<b>(</b>slot<b>)</b></span>
<span id='line78'>        map<b>[</b>slot.name<b>]</b> = slot</span>
<span id='line79'>      <b>}</b></span>
<span id='line80'></span>
<span id='line81'>      // construct DocType from my own fields</span>
<span id='line82'>      return DocType<b>(</b>pod, attrs, typeRef, list, map<b>)</b></span>
<span id='line83'>    <b>}</b></span>
<span id='line84'>    finally <b>{</b> if <b>(</b>close<b>)</b> in.close <b>}</b></span>
<span id='line85'>  <b>}</b></span>
<span id='line86'></span>
<span id='line87'>  private DocSlot? parseSlot<b>(</b><b>)</b></span>
<span id='line88'>  <b>{</b></span>
<span id='line89'>    // check if at end of file</span>
<span id='line90'>    if <b>(</b>cur.isEmpty<b>)</b> return null</span>
<span id='line91'></span>
<span id='line92'>    // "-- " &lt;name> &lt;sp> &lt;type> <b>[</b>":=" &lt;expr><b>]</b></span>
<span id='line93'>    // "-- " &lt;name> "<b>(</b>" &lt;nl> <b>[</b>&lt;param> &lt;nl><b>]</b>* "<b>)</b>" &lt;return></span>
<span id='line94'>    if <b>(</b>!cur.startsWith<b>(</b>"-- "<b>)</b><b>)</b> throw Err<b>(</b>"Expected -- &lt;name>"<b>)</b></span>
<span id='line95'>    if <b>(</b>cur<b>[</b>cur.size-1<b>]</b> == '<b>(</b>'<b>)</b></span>
<span id='line96'>      return parseMethod</span>
<span id='line97'>    else</span>
<span id='line98'>      return parseField</span>
<span id='line99'>  <b>}</b></span>
<span id='line100'></span>
<span id='line101'>  private DocField parseField<b>(</b><b>)</b></span>
<span id='line102'>  <b>{</b></span>
<span id='line103'>    //  "-- " &lt;name> &lt;sp> &lt;type> <b>[</b>":=" &lt;expr><b>]</b></span>
<span id='line104'>    sp    := cur.index<b>(</b>" ", 4<b>)</b></span>
<span id='line105'>    initi := cur.index<b>(</b>":=", sp+1<b>)</b></span>
<span id='line106'>    name  := cur<b>[</b>3..&lt;sp<b>]</b></span>
<span id='line107'>    type  := cur<b>[</b>sp+1 ..&lt; <b>(</b>initi ?: cur.size<b>)</b><b>]</b></span>
<span id='line108'>    init  := initi == null ? null : cur<b>[</b>initi+2..-1<b>]</b></span>
<span id='line109'>    consumeLine</span>
<span id='line110'>    attrs  := parseAttrs</span>
<span id='line111'>    return DocField<b>(</b>attrs, typeRef, name, DocTypeRef<b>(</b>type<b>)</b>, init<b>)</b></span>
<span id='line112'>  <b>}</b></span>
<span id='line113'></span>
<span id='line114'>  private DocMethod parseMethod<b>(</b><b>)</b></span>
<span id='line115'>  <b>{</b></span>
<span id='line116'>    // "-- " &lt;name> "<b>(</b>" &lt;nl> <b>[</b>&lt;param> &lt;nl><b>]</b>* "<b>)</b>" &lt;return></span>
<span id='line117'></span>
<span id='line118'>    // tokenize by space</span>
<span id='line119'>    name := cur<b>[</b>3..-2<b>]</b></span>
<span id='line120'>    consumeLine</span>
<span id='line121'></span>
<span id='line122'>    // parse params</span>
<span id='line123'>    params := DocParam<b>[</b>,<b>]</b></span>
<span id='line124'>    while <b>(</b>cur<b>[</b>0<b>]</b> != '<b>)</b>'<b>)</b></span>
<span id='line125'>    <b>{</b></span>
<span id='line126'>      sp    := cur.index<b>(</b>" "<b>)</b></span>
<span id='line127'>      defi_  := cur.index<b>(</b>":=", sp+1<b>)</b></span>
<span id='line128'>      pname := cur<b>[</b>0..&lt;sp<b>]</b></span>
<span id='line129'>      type  := cur<b>[</b>sp+1 ..&lt; <b>(</b>defi_ ?: cur.size<b>)</b><b>]</b></span>
<span id='line130'>      def   := defi_ == null ? null : cur<b>[</b>defi_+2..-1<b>]</b></span>
<span id='line131'>      params.add<b>(</b>DocParam<b>(</b>DocTypeRef<b>(</b>type<b>)</b>, pname, def<b>)</b><b>)</b></span>
<span id='line132'>      consumeLine</span>
<span id='line133'>    <b>}</b></span>
<span id='line134'>    returns := DocTypeRef<b>(</b>cur<b>[</b>2..-1<b>]</b><b>)</b></span>
<span id='line135'>    consumeLine</span>
<span id='line136'></span>
<span id='line137'>    // attrs, facets, and doc</span>
<span id='line138'>    attrs := parseAttrs</span>
<span id='line139'>    attrs.flags = attrs.flags.and<b>(</b>DocFlags.Const.not<b>)</b></span>
<span id='line140'>    return DocMethod<b>(</b>attrs, typeRef, name, returns, params<b>)</b></span>
<span id='line141'>  <b>}</b></span>
<span id='line142'></span>
<span id='line143'>  ** Parse meta name/val pairs, facets, and fandoc section</span>
<span id='line144'>  private DocAttrs parseAttrs<b>(</b><b>)</b></span>
<span id='line145'>  <b>{</b></span>
<span id='line146'>    attrs := DocAttrs<b>(</b><b>)</b></span>
<span id='line147'>    parseMeta<b>(</b>attrs<b>)</b></span>
<span id='line148'>    parseFacets<b>(</b>attrs<b>)</b></span>
<span id='line149'>    parseDoc<b>(</b>attrs<b>)</b></span>
<span id='line150'>    return attrs</span>
<span id='line151'>  <b>}</b></span>
<span id='line152'></span>
<span id='line153'>  private Void parseMeta<b>(</b>DocAttrs attrs<b>)</b></span>
<span id='line154'>  <b>{</b></span>
<span id='line155'>    while <b>(</b>!cur.isEmpty &amp;&amp; cur<b>[</b>0<b>]</b>.isAlpha<b>)</b></span>
<span id='line156'>    <b>{</b></span>
<span id='line157'>      eq   := cur.index<b>(</b>"="<b>)</b></span>
<span id='line158'>      name := cur<b>[</b>0..&lt;eq<b>]</b></span>
<span id='line159'>      val  := cur<b>[</b>eq+1..-1<b>]</b></span>
<span id='line160'>      switch <b>(</b>name<b>)</b></span>
<span id='line161'>      <b>{</b></span>
<span id='line162'>        case "loc":    parseLoc<b>(</b>attrs, val<b>)</b></span>
<span id='line163'>        case "flags":  attrs.flags = DocFlags.fromNames<b>(</b>val<b>)</b></span>
<span id='line164'>        case "base":   attrs.base   = parseTypeList<b>(</b>val<b>)</b></span>
<span id='line165'>        case "mixins": attrs.mixins = parseTypeList<b>(</b>val<b>)</b></span>
<span id='line166'>        case "set":    attrs.setterFlags = DocFlags.fromNames<b>(</b>val<b>)</b></span>
<span id='line167'>      <b>}</b></span>
<span id='line168'>      consumeLine</span>
<span id='line169'>    <b>}</b></span>
<span id='line170'>  <b>}</b></span>
<span id='line171'></span>
<span id='line172'>  private Void parseLoc<b>(</b>DocAttrs attrs, Str val<b>)</b></span>
<span id='line173'>  <b>{</b></span>
<span id='line174'>    colon   := val.index<b>(</b>":"<b>)</b></span>
<span id='line175'>    slash   := val.indexr<b>(</b>"/"<b>)</b></span>
<span id='line176'>    file    := colon == 0 ? this.typeLoc.file : val<b>[</b>0..&lt;colon<b>]</b></span>
<span id='line177'>    line    := val<b>[</b>colon+1 ..&lt; <b>(</b>slash ?: val.size<b>)</b><b>]</b>.toInt</span>
<span id='line178'>    docLine := slash != null ? val<b>[</b>slash+1..-1<b>]</b>.toInt : line</span>
<span id='line179'>    attrs.loc    = DocLoc<b>(</b>file, line<b>)</b></span>
<span id='line180'>    attrs.docLoc = DocLoc<b>(</b>file, docLine<b>)</b></span>
<span id='line181'>  <b>}</b></span>
<span id='line182'></span>
<span id='line183'>  private DocTypeRef<b>[</b><b>]</b> parseTypeList<b>(</b>Str val<b>)</b></span>
<span id='line184'>  <b>{</b></span>
<span id='line185'>    val.split.map |tok->DocTypeRef| <b>{</b> DocTypeRef<b>(</b>tok<b>)</b> <b>}</b></span>
<span id='line186'>  <b>}</b></span>
<span id='line187'></span>
<span id='line188'>  private Void parseFacets<b>(</b>DocAttrs attrs<b>)</b></span>
<span id='line189'>  <b>{</b></span>
<span id='line190'>    facet := parseFacet</span>
<span id='line191'>    if <b>(</b>facet == null<b>)</b> return</span>
<span id='line192'>    acc := <b>[</b>facet<b>]</b></span>
<span id='line193'>    while <b>(</b><b>(</b>facet = parseFacet<b>)</b> != null<b>)</b> acc.add<b>(</b>facet<b>)</b></span>
<span id='line194'>    attrs.facets = acc</span>
<span id='line195'>  <b>}</b></span>
<span id='line196'></span>
<span id='line197'>  private DocFacet? parseFacet<b>(</b><b>)</b></span>
<span id='line198'>  <b>{</b></span>
<span id='line199'>    if <b>(</b>!cur.startsWith<b>(</b>"@"<b>)</b><b>)</b> return null</span>
<span id='line200'></span>
<span id='line201'>    complex := cur<b>[</b>cur.size-1<b>]</b> == '<b>{</b>'</span>
<span id='line202'>    type := DocTypeRef<b>(</b>cur<b>[</b>1..<b>(</b>complex ? -2 : -1<b>)</b><b>]</b><b>)</b></span>
<span id='line203'>    fields := DocFacet.noFields</span>
<span id='line204'></span>
<span id='line205'>    consumeLine</span>
<span id='line206'>    if <b>(</b>complex<b>)</b></span>
<span id='line207'>    <b>{</b></span>
<span id='line208'>      fields = OrderedMap&lt;Str,Str><b>(</b><b>)</b>//<b>[</b>:<b>]</b></span>
<span id='line209'>      //fields.ordered = true</span>
<span id='line210'>      while <b>(</b>cur != "<b>}</b>"<b>)</b></span>
<span id='line211'>      <b>{</b></span>
<span id='line212'>        eq := cur.index<b>(</b>"="<b>)</b></span>
<span id='line213'>        name := cur<b>[</b>0..&lt;eq<b>]</b></span>
<span id='line214'>        val  := cur<b>[</b>eq+1..-1<b>]</b></span>
<span id='line215'>        fields<b>[</b>name<b>]</b> = val</span>
<span id='line216'>        consumeLine</span>
<span id='line217'>      <b>}</b></span>
<span id='line218'>      consumeLine  // trailing "<b>}</b>"</span>
<span id='line219'>    <b>}</b></span>
<span id='line220'></span>
<span id='line221'>    return DocFacet<b>(</b>type, fields<b>)</b></span>
<span id='line222'>  <b>}</b></span>
<span id='line223'></span>
<span id='line224'>  private Void parseDoc<b>(</b>DocAttrs attrs<b>)</b></span>
<span id='line225'>  <b>{</b></span>
<span id='line226'>    if <b>(</b>!cur.isEmpty<b>)</b> throw Err<b>(</b>"expecting empty line"<b>)</b></span>
<span id='line227'>    consumeLine</span>
<span id='line228'></span>
<span id='line229'>    s := StrBuf<b>(</b>256<b>)</b></span>
<span id='line230'>    while <b>(</b>!eof &amp;&amp; !cur.startsWith<b>(</b>"-- "<b>)</b><b>)</b></span>
<span id='line231'>    <b>{</b></span>
<span id='line232'>      s.add<b>(</b>cur<b>)</b>.addChar<b>(</b>'\n'<b>)</b></span>
<span id='line233'>      consumeLine</span>
<span id='line234'>    <b>}</b></span>
<span id='line235'>    attrs.doc = DocFandoc<b>(</b>attrs.docLoc, s.toStr<b>)</b></span>
<span id='line236'>  <b>}</b></span>
<span id='line237'></span>
<span id='line238'>  private Void consumeLine<b>(</b><b>)</b></span>
<span id='line239'>  <b>{</b></span>
<span id='line240'>    next := in.readLine</span>
<span id='line241'>    if <b>(</b>next != null<b>)</b> cur = next</span>
<span id='line242'>    else <b>{</b> cur = ""; eof = true <b>}</b></span>
<span id='line243'>  <b>}</b></span>
<span id='line244'></span>
<span id='line245'>  private InStream in</span>
<span id='line246'>  private const DocPod pod</span>
<span id='line247'>  private Str cur := ""</span>
<span id='line248'>  private DocLoc typeLoc := DocLoc.unknown</span>
<span id='line249'>  private DocTypeRef? typeRef</span>
<span id='line250'>  private Bool eof</span>
<span id='line251'><b>}</b></span>
<span id='line252'></span>
<span id='line253'>internal class DocAttrs</span>
<span id='line254'><b>{</b></span>
<span id='line255'>  Int flags</span>
<span id='line256'>  DocLoc loc := DocLoc.unknown</span>
<span id='line257'>  DocLoc docLoc := DocLoc.unknown</span>
<span id='line258'>  Int? setterFlags</span>
<span id='line259'>  DocTypeRef<b>[</b><b>]</b> base   := List.defVal//DocTypeRef#.emptyList</span>
<span id='line260'>  DocTypeRef<b>[</b><b>]</b> mixins := List.defVal//DocTypeRef#.emptyList</span>
<span id='line261'>  DocFacet<b>[</b><b>]</b> facets   := List.defVal//DocFacet#.emptyList</span>
<span id='line262'>  DocFandoc? doc</span>
<span id='line263'><b>}</b></span>
</pre>
</div>
</body>
</html>
